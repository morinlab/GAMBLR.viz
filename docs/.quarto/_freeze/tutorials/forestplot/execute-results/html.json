{
  "hash": "c7404db76aeb29fc886d0032f0da157a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Tutorial: The prettiest forestplot\"\nwarning: false\nmessage: false\nfig.width: 10\nfig.height: 8\nfig.align: \"center\"\n---\n\n\n\n\nOne of the integral parts of this package is the analysis and display of the\ndifferences in the frequency of mutations for two different groups in a given\ncohort. Because it is easy to use, conducts flexible comparisons, and generates\neasy-to-follow display items, it is called `prettyForestPlot` and it belongs to\nthe `pretty` family of GAMBLR.viz functions.\nThere is no specific formatting or data preparation needed for the analysis and\nvisualization, and the only required inputs are the mutation data (can be maf\nformat or binary feature matrix), metadata (containing sample identifiers in\n`sample_id` column and annotation of the group that will be used in comparison),\nand a character of the column name in metadata where the sample annotations are\nspecified.\nThis tutorial will demonstate the example of the inputs and showcase the main\nfeatures of this function.\n\n## Prepare setup\n\nWe will first import the necessary packages:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load packages\nlibrary(GAMBLR.open)\nlibrary(tibble)\nlibrary(dplyr)\n```\n:::\n\n\n\n\nNext, we will get some data to display. The metadata is expected to be a data\nframe with one required column: `sample_id` and another column that will contain\nsample annotations according to the comparison group. In this example, we will\nuse as example the data set and variant calls from the\n[study](https://doi.org/10.1182/blood.2022016534) that identified\ngenetic subgroup of Burkitt lymphoma (BL).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmetadata <- get_gambl_metadata() %>%\n    filter(cohort == \"BL_Thomas\")\n```\n:::\n\n\n\n\nNext, we will obtain the coding mutations that will be used in the plotting.\nThe data is a data frame in a standartized maf format.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaf <- get_ssm_by_samples(\n    these_samples_metadata = metadata,\n    tool_name = \"publication\",\n    projection = \"hg38\"\n)\n\n# How does it look like?\ndim(maf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 47043    49\n```\n\n\n:::\n\n```{.r .cell-code}\nhead(maf) %>%\n    select(\n        Tumor_Sample_Barcode,\n        Hugo_Symbol,\n        Variant_Classification\n    )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\ngenomic_data Object\nGenome Build: hg38 \nShowing first 10 rows:\n  Tumor_Sample_Barcode Hugo_Symbol Variant_Classification\n1                Akata        CPTP      Missense_Mutation\n2                Akata      FNDC10      Missense_Mutation\n3                Akata       MORN1      Missense_Mutation\n4                Akata       MEGF6      Missense_Mutation\n5                Akata       NPHP4                 Silent\n6                Akata      GPR157      Missense_Mutation\n```\n\n\n:::\n:::\n\n\n\n\nFor the purpose of this tutorial, we will focus on a small subset of genes known\nto be significantly mutated in BL.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngenes <- lymphoma_genes_bl_v_latest$Gene\nhead(genes)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"ARID1A\" \"BACH2\"  \"BCL6\"   \"BCL7A\"  \"BMP7\"   \"CCND3\" \n```\n\n\n:::\n:::\n\n\n\n\nNow we have our metadata and mutations we want to explore, so we are ready to\nstart visualizing the data.\n\n## The default forest plot\n\nThe forest plot is ready to be called with the default parameters after just\nproviding the metadata and data frame with mutations in standard maf format.\nHere is an example of the output with all default parameters:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomparison_column <- \"EBV_status_inf\" # character of column name for comparison\nfp <- prettyForestPlot(\n    metadata = metadata,\n    maf = maf,\n    genes = genes,\n    comparison_column = comparison_column\n)\n```\n:::\n\n\n\n\nThe output of the function is a list containing the following objects:\n- `fisher`: a data frame with detailed statistics of the Fisher's test for each\ngene\n- `mutmat`: a binary matrix used for the Fisher's test\n- `forest`: a ggplot2 object with the forest plot of the ORs from the Fisher's\ntest for each gene\n- `bar`: a ggplot2 object wiht mutation frequencies for each Gene\n- `arranged`: a display item where both the forest and bar plots are nicely\narranged side-by-side\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(fp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"fisher\"   \"forest\"   \"bar\"      \"arranged\" \"mutmat\"  \n```\n\n\n:::\n:::\n\n\n\n\n## Report only significant differences\n\nBy default, all of the genes of interest are reported in the output. After the\nFisher's test is performed, the `prettyForestPlot` also calculates FDR and we\ncan use it to only report significant differences by providing a significance\ncutoff with the parameter `max_q`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmax_q <- 0.1 # only those qith Q value <= 0.1 will be reported\nfp <- prettyForestPlot(\n    metadata = metadata,\n    maf = maf,\n    genes = genes,\n    comparison_column = comparison_column,\n    max_q = max_q\n)\n```\n:::\n\n\n\n\nWe now can take a look at what genes are passing the significance cutoff:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfp$arranged\n```\n\n::: {.cell-output-display}\n![](forestplot_files/figure-html/fdr_plot-1.png){width=672}\n:::\n:::\n\n\n\n\n## Comparing categories with more than two groups\n\nAs the `prettyForestPlot` construcst the 2x2 contingency tables to run Fisher's\ntest to find significant differences, it can only operate on comparing 2 groups\nbetween themselves - but what if you have more than that and want to see the\ndifference between some of them?\nTo handle this scenario, we can take advantage of the `comparison_values`\nparameter, which will be used to subset the metadata to only requested groups\nand only perform testing and plotting on this subset. Let's see it in action:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomparison_column <- \"genetic_subgroup\" # change the comparison column\ncomparison_values <- c(\"IC-BL\", \"Q53-BL\")\nfp <- prettyForestPlot(\n    metadata = metadata,\n    maf = maf,\n    genes = genes,\n    comparison_column = comparison_column,\n    comparison_values = comparison_values,\n    max_q = max_q\n)\n\nfp$arranged\n```\n\n::: {.cell-output-display}\n![](forestplot_files/figure-html/comp_groups-1.png){width=672}\n:::\n:::\n\n\n\n\nThis plot is exactly reproducing the Supplemmental Figure 12D from the\n[Thomas et al](https://doi.org/10.1182/blood.2022016534) study!\n\n## Separating genes with hotspots\n\nWe can additionally separate hotspots from the other mutations and compare those\nseparately. First, we need to annotate the maf data, for which we will use the\n`annotate_hotspots` from GAMBLR family. This function will add a new column to\nthe maf named `hot_spot` indicating whether or not the specific mutation is in\nthe hotspot region.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Annotate hotspots\nmaf <- annotate_hotspots(maf)\n\n# What are the hotspots?\nmaf %>%\n    filter(hot_spot) %>%\n    select(Hugo_Symbol, hot_spot) %>%\n    table()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n< table of extent 0 x 0 >\n```\n\n\n:::\n:::\n\n\n\n::: {.callout-note}\nThe GAMBLR.data version of the `annotate_hotspots` only handles very specific\ngenes and does not have functionality to annotate all hotspots.\n:::\n\nOh no! Looks like there is no hotspots in this maf data. This does not make\nsense, so what happened? Aha, the hotspot annotation in GAMBLR.data works only\non the data in grch37 projection. But our maf is in hg38, so what should we do?\nOne way is to lift the maf data to another projection using the UCSC's liftOver,\nand GAMBLR family has exactly the function that serves this purpose:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaf_grch37 <- liftover(\n    maf,\n    mode = \"maf\",\n    target_build = \"grch37\"\n) %>%\nmutate(Chromosome = gsub(\"chr\", \"\", Chromosome)) %>%\nselect(-hot_spot) # since it is empty we can just drop it\n```\n:::\n\n\n\n\nCan we annotate the hotspots now?\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaf_grch37 <- annotate_hotspots(maf_grch37)\n\n# What are the hotspots?\nmaf_grch37 %>%\n    filter(hot_spot) %>%\n    select(Hugo_Symbol, hot_spot) %>%\n    table()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           hot_spot\nHugo_Symbol TRUE\n     CREBBP    1\n     EZH2      1\n     FOXO1    60\n     MYD88     2\n     STAT6     4\n```\n\n\n:::\n:::\n\n\n\n\nIndeed, the hotspots are properly annotated once we have maf in correct\nprojection. Now, we can simply toggle the `separate_hotspots` parameter to\nperform separate comparisons within hotspots:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomparison_column <- \"EBV_status_inf\"\nfp <- prettyForestPlot(\n    metadata = metadata,\n    maf = maf_grch37,\n    genes = genes,\n    comparison_column = comparison_column,\n    max_q = max_q,\n    separate_hotspots = TRUE\n)\n\nfp$arranged\n```\n\n::: {.cell-output-display}\n![](forestplot_files/figure-html/comp_hotspots-1.png){width=672}\n:::\n:::\n\n\n\n\n## Using binary matrix as input\n\nSometimes it might be useful to have different input format instead of maf - for example, binary matrix of features. Can we use the `prettyForestPlot` in this\ncase? Yes, sure we can!\n\nFirst, let's construct the binary matrix. We will supplement our maf with the\nnon-coding mutations to look at the aSHM regions in addition to coding\nmutations, and this will already give us the data in correct projection:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaf <- get_ssm_by_samples(\n    these_samples_metadata = metadata\n)\nmaf$Variant_Classification %>% table\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n.\n               3'Flank                  3'UTR                5'Flank \n                  1457                    513                   2957 \n                 5'UTR        Frame_Shift_Del        Frame_Shift_Ins \n                  1102                    124                     97 \n                   IGR           In_Frame_Del           In_Frame_Ins \n                   457                     40                     14 \n                Intron      Missense_Mutation      Nonsense_Mutation \n                 44397                   1859                    286 \n      Nonstop_Mutation                    RNA                 Silent \n                     6                     74                    481 \n         Splice_Region            Splice_Site Translation_Start_Site \n                   148                    114                     22 \n```\n\n\n:::\n:::\n\n\n\n\nNow we convert this maf into binary matrix:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Generate binary matrix\ncoding_matrix <- get_coding_ssm_status(\n    these_samples_metadata = metadata,\n    maf_data = maf,\n    gene_symbols = genes,\n    include_hotspots = TRUE,\n    review_hotspots = TRUE\n)\n```\n:::\n\n\n\n\nNext, supplement this with the matrix of non-coding mutation across aSHM regions\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# We'll use the aSHM regions defined in GAMBLR.data\n# Let our helper function massage it into a consistent format\nregions_bed = create_bed_data(somatic_hypermutation_locations_GRCh37_v0.2,\n                              fix_names=\"concat\",\n                              concat_cols=c(\"gene\",\"region\"),\n                              sep=\"-\")\n\n# Generate matrix of mutations per each site\nashm_matrix <- get_ashm_count_matrix(\n    regions_bed = regions_bed,\n    these_samples_metadata = metadata\n)\n\n# Binarize matrix using arbitrary 3 muts/region cutoff\nashm_matrix[ashm_matrix <= 3] = 0\nashm_matrix[ashm_matrix > 3] = 1\nashm_matrix <- ashm_matrix %>%\n    rownames_to_column(\"sample_id\")\n```\n:::\n\n\n\n\n\nWe can now combine both coding and non-coding features into single matrix:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfeature_matrix <- left_join(\n    coding_matrix,\n    ashm_matrix\n)\n\n# Drop any fearures absent across at least 10 samples to clean any noise\nfeature_matrix <- feature_matrix %>%\n    select_if(is.numeric) %>%\n    select(where(~ sum(. > 0, na.rm = TRUE) >= 10)) %>%\n    bind_cols(\n        feature_matrix %>% select(sample_id),\n        .\n    )\n```\n:::\n\n\n\n\nNow we can provide the binary matrix to the `prettyForestPlot` and regenerate\nthe Supplemmental Figure 12C from the\n[Thomas et al](https://doi.org/10.1182/blood.2022016534) study!\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncomparison_column <- \"genetic_subgroup\"\ncomparison_values <- c(\"DGG-BL\", \"Q53-BL\")\nfp <- prettyForestPlot(\n    metadata = metadata,\n    mutmat = feature_matrix,\n    genes = genes,\n    comparison_column = comparison_column,\n    comparison_values = comparison_values,\n    max_q = max_q\n)\n\nfp$arranged\n```\n\n::: {.cell-output-display}\n![](forestplot_files/figure-html/comp_mat-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "forestplot_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}