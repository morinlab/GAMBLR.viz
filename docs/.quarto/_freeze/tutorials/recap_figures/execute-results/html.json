{
  "hash": "ee87930d0842bd347ce280ec3a6d7766",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Tutorial: Regenerating figures from published manuscripts\"\nwarning: false\nmessage: false\nfig.width: 10\nfig.height: 7\nfig.align: \"center\"\n---\n\n\n\nWhen preparing a manuscript for publication, it is important to maintain a\nvisual identity throughout display items. With GAMBLR.viz, it is easy to keep\nup with a consistent theme, color pallette, fonts and font sizes.\n<br>\nThis tutorial will demonstate how to regenerate figures from some of the\nmanuscripts previously published by Morin Lab, in particular study by\n[Dreval et al.](https://doi.org/10.1182/blood.2022018719)\n\n## Prepare setup\n\nWe will first import the necessary packages:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load\nlibrary(readxl)\nlibrary(ComplexHeatmap)\nlibrary(ggbeeswarm)\nlibrary(ggpubr)\nlibrary(GAMBLR.open)\nlibrary(tidyverse)\n```\n:::\n\n\n\nNext, we will use the standard color pallette and store it in a variable for\neasy access:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncolors <- get_gambl_colours()\n```\n:::\n\n\n\n\nFinally, we will set the consistent GAMBLR-specific ggplot theme for this\ntutorial:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(theme_Morons())\n```\n:::\n\n\n\n## Differential gene expression between FL subgroups\n\nThe Figure 4A of the [Dreval et al](https://doi.org/10.1182/blood.2022018719)\nshows that there is a differential gene expression of CREBBP, FOXP1, and MYC\nbetween genetic subgroups of FL described in that paper. We can regenerate it\nhere to confirm the published results and demonstate how easy it is to work with\nGAMBLR.viz.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Get metadata\nmetadata <- get_gambl_metadata() %>%\n    filter(\n        cohort == \"FL_Dreval\",\n        pathology %in% c(\"FL\", \"DLBCL\")\n    )\n```\n:::\n\n\n\nNext, we can take advantage of the publicly available gene expression data and\naccess it directly. The data is provided with the ENSEMBL identifiers, so we\nwill need to make the conversion between human-readable and ENSEMBL identifiers.\nThere is no need to search for this linkage as it is direcly available with\nGAMBLR family:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nidentifiers <- grch37_gene_coordinates %>%\n    filter(gene_name %in% c(\"CREBBP\", \"FOXP1\", \"MYC\")) %>%\n    select(ensembl_gene_id, gene_name)\n```\n:::\n\n\n\nNow we can access the gene expression data and prepare it for plotting\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get gene expression\nexpression <- read_tsv(\n        \"https://www.bcgsc.ca/downloads/morinlab/cFL_Blood_2023_GE.tsv.gz\"\n    ) %>%\n    filter(ensembl_gene_id %in% identifiers$ensembl_gene_id) %>%\n    # add human-readable identifiers\n    left_join(\n        identifiers,\n        .\n    )\n\nexpression <- expression %>%\n    # convert to long format\n    pivot_longer(\n        !c(ensembl_gene_id, gene_name),\n        names_to = \"sample_id\",\n        values_to = \"expression\"\n    ) %>%\n    # add genetic metadata labels\n    left_join(\n        .,\n        metadata %>%\n            select(sample_id, pathology, genetic_subgroup)\n    ) %>%\n    # prepare grouping label and set consistent level order\n    mutate(\n        comp_group = ifelse(\n            pathology == \"DLBCL\",\n            pathology,\n            genetic_subgroup\n        ),\n        comp_group = factor(\n            comp_group,\n            levels = c(\"DLBCL\", \"dFL\", \"cFL\")\n        )\n    ) %>%\n    drop_na()\n```\n:::\n\n\n\nNow we can perform statistical comparisons to find differences in gene\nexpression:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npwc <- expression %>%\n    group_by(gene_name) %>%\n    rstatix::wilcox_test(\n        expression ~ comp_group\n    )\n\n# Add coordinates for position of brackets\npwc <- pwc %>%\n    rstatix::add_xy_position(x = \"comp_group\")\n```\n:::\n\n\n\nThe Plot!\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- expression %>%\n    ggplot(\n        aes(\n            x = comp_group,\n            y = expression,\n            color = comp_group\n        )\n    ) +\n    geom_boxplot() +\n    geom_quasirandom() +\n    stat_pvalue_manual(\n        pwc,\n        hide.ns = TRUE,\n        size = 8,\n        label = \"p.adj.signif\"\n    ) +\n    facet_grid(cols = vars(gene_name)) +\n    scale_color_manual(values = colors) +\n    ylab(\"Expression\") +\n    theme(\n        axis.title.x = element_blank()\n    )\n\np\n```\n\n::: {.cell-output-display}\n![](recap_figures_files/figure-html/ge_plot-1.png){width=672}\n:::\n:::\n\n\n\n## Differentially mutated genes between DLBCL and FL\n\nThe same paper by [Dreval et al](https://doi.org/10.1182/blood.2022018719)\nshowed in the Supplemental Figure 1B the genes mutated at differential\nfrequencies between FL and DLBCL. We can also easily regenerate that plot:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# First obtain maf data\nmaf <- get_ssm_by_samples(\n    these_samples_metadata = metadata,\n    tool_name = \"publication\"\n)\n\n# The Plot!\np <- prettyForestPlot(\n    maf = maf,\n    metadata = metadata,\n    comparison_column = \"pathology\",\n    comparison_values = c(\"DLBCL\", \"FL\"),\n    max_q = 0.1,\n    genes = c(lymphoma_genes$Gene, \"VMA21\")\n)\n\np$arranged\n```\n\n::: {.cell-output-display}\n![](recap_figures_files/figure-html/fl_forest-1.png){width=672}\n:::\n:::\n\n\n\n## Patterns of mutations at common aSHM target sites\n\nThe study of FL by [Dreval et al](https://doi.org/10.1182/blood.2022018719) in\nthe Supplemental Figure 4A demonstrated and important visualization of the\npatterns of mutations at common aSHM target sites across DLBCL and FL when\ncomparing tumors in the discovery cohort. We can recapitulate that figure in\nthis tutorial using the data bundled with GAMBLR and visualization functions\navailable with GAMBLR.viz.\n\nFirst, we will retreive the metadata exactly as it is provided in the paper:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read supplemental table from that paper\nmetadata <- read_xlsx(\n    system.file(\n        \"extdata\",\n        \"studies/FL_Dreval.xlsx\",\n        package = \"GAMBLR.data\"\n    )\n)\n\n# What is provided in the supplemental table?\ncolnames(metadata)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"Patient barcode\"           \"Pairing status\"           \n [3] \"Genome sample id\"          \"Normal sample id\"         \n [5] \"Sex\"                       \"Age at diagnosis\"         \n [7] \"Pathology\"                 \"FL grade\"                 \n [9] \"Analysis cohort\"           \"Tumor biopsy\"             \n[11] \"Reference\"                 \"MYC FISH BA\"              \n[13] \"BCL2 FISH BA\"              \"BCL6 FISH BA\"             \n[15] \"MYC WGS Tx\"                \"BCL2 WGS Tx\"              \n[17] \"BCL6 WGS Tx\"               \"Tumor purity\"             \n[19] \"total N of SSM\"            \"PGA\"                      \n[21] \"Analysis\"                  \"cFL/dFL label\"            \n[23] \"SeqType\"                   \"AverageBaseQuality\"       \n[25] \"AverageInsertSize\"         \"AverageReadLength\"        \n[27] \"PairsOnDiffCHR\"            \"TotalReads\"               \n[29] \"TotalUniquelyMapped\"       \"TotalUnmappedreads\"       \n[31] \"TotalDuplicatedreads\"      \"ProportionReadsDuplicated\"\n[33] \"ProportionReadsMapped\"     \"MeanCorrectedCoverage\"    \n[35] \"ProportionCoverage10x\"     \"ProportionCoverage30x\"    \n```\n\n\n:::\n\n```{.r .cell-code}\n# Select and rename columns that we need for heatmap\nmetadata <- metadata %>%\n    select(\n        sample_id = `Genome sample id`,\n        `Analysis cohort`,\n        \"BCL2 Status\" = `BCL2 WGS Tx`\n    ) %>%\n    mutate(\n        # convert from boolean to character\n        `BCL2 Status` = ifelse(`BCL2 Status`, \"POS\", \"NEG\"),\n        # adding seq type for compatibility with plotting\n        seq_type = \"genome\"\n    )\n```\n:::\n\n\n\nWe also want to ensure the consistent ordering of the Analysis cohort as the\nannotation track associated with heatmap. By default, the values will be sorted\nalphabetically, but we will set the ordering more informed biologically by\nconverting that column to a factor:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmetadata <- metadata %>%\n    mutate(\n        `Analysis cohort` = factor(\n            `Analysis cohort`,\n            levels = c(\n                \"denovo-DLBCL\",\n                \"no-HT\",\n                \"pre-HT\",\n                \"post-HT\",\n                \"COM\"\n            )\n        )\n    )\n```\n:::\n\n\n\nWe will now also collect mutations for these samples:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaf <- get_ssm_by_samples(\n    these_samples_metadata = metadata,\n    tool_name = \"publication\"\n)\n```\n:::\n\n\nNow, we need a bed-formatted data frame with coordinates for the regions of\ninterest. We will use the aSHM regions from GAMBLR, and will use the same\nversion as was used in the original paper:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsome_regions <- somatic_hypermutation_locations_GRCh37_v0.2 %>%\n    select(1:4) %>%\n    rename(\n        \"chrom\" = \"chr_name\",\n        \"start\" = \"hg19_start\",\n        \"end\" = \"hg19_end\",\n        \"name\" = \"gene\"\n    ) %>%\n    mutate(chrom = str_remove(chrom, \"chr\"))\n\n#set factor ordering for later\nsome_regions$name <- factor(\n    some_regions$name,\n    levels = sort(unique(some_regions$name))\n)\n```\n:::\n\n\n\nNow, we can plot the heatmap of mutations using the GAMBLR.viz function\n`heatmap_mutation_frequency_bin`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nashm_heatmap <- heatmap_mutation_frequency_bin(\n    these_samples_metadata = metadata,\n    maf_data = maf,\n    cluster_rows_heatmap = FALSE,\n    regions_bed = some_regions,\n    min_bin_recurrence = 10,\n    region_fontsize = 12,\n    window_size = 1000,\n    slide_by = 500,\n    orientation = \"sample_columns\",\n    sortByColumns = c(\"Analysis cohort\", \"BCL2 Status\"),\n    metadataColumns = c(\"BCL2 Status\", \"Analysis cohort\"),\n    backgroundColour = \"white\",\n    return_heatmap_obj = TRUE,\n    customColours = list(\n        \"Analysis cohort\" = get_gambl_colours(),\n        \"BCL2 Status\" = get_gambl_colours(\"clinical\")\n    )\n)\n\nComplexHeatmap::draw(\n    ashm_heatmap,\n    heatmap_legend_side = \"bottom\",\n    annotation_legend_side = \"bottom\"\n)\n```\n\n::: {.cell-output-display}\n![](recap_figures_files/figure-html/ashm_plot-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "recap_figures_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}